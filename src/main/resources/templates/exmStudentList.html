<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml"
      layout:decorator="layout/secure"
      lang="en">
<head>
    <title>
        Student List
    </title>
</head>
<body>
<div layout:fragment="page-content">
    <div class="row">
        <div class="col-lg-12">
            <h1>
                Result
            </h1>
        </div>
    </div>


    <div class="row separator">
        <div class="col-lg-8 est esb">

            <input type="hidden" name="clsId" id="clsId" th:value="${clsId}" />

            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="row">
                        <div class="form-group">
                            <div class="col-lg-6 est">
                                Exam Type
                            </div>
                            <div class="col-lg-6 est">
                                <select id="examType" class="form-control">
                                    <option th:each="state : ${T(com.lynas.model.util.ExamType).values()}"
                                            th:value="${state}"
                                            th:text="${state}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-lg-6 est">
                                Subject
                            </div>
                            <div class="col-lg-6 est">
                                <select id="subject" class="form-control">
                                    <option th:each="sub : ${subjectList}"
                                            th:value="${sub.id}"
                                            th:text="${sub.subjectName}"></option>
                                </select>
                            </div>
                            <div class="col-lg-6 est">
                                Total Mark
                            </div>
                            <div class="col-lg-6 est">
                                <input type="input" class="form-control" name="totalMark" id="totalMark" />
                            </div>
                            <div class="col-lg-6 est">
                                Percentile
                            </div>
                            <div class="col-lg-6 est">
                                <input type="input" class="form-control" name="percentile" id="percentile" />
                            </div>
                            <div class="col-lg-6 est">
                                Date
                            </div>
                            <div class="col-lg-6 est">
                                <input type="input" class="form-control date" name="date" id="date"/>
                            </div><div class="col-lg-6 est">
                                Year
                            </div>
                            <div class="col-lg-6 est">
                                <input type="input" class="form-control" name="year" id="year" th:value="${session.currentYear}"/>
                            </div>
                        </div>
                    </div>


                </div>
            </div>


                <form  id="form_submit" role="form" method="post" action="/exams">
                    <table class="table table-striped separator student-list">

                        <th>Role Number</th>
                        <th>Student Name</th>
                        <th>Mark Obtain</th>
                        <th>Present</th>


                        <div th:each="std, stat : ${studentList}">
                            <tr>
                                <td th:text="${std.roleNumber}"></td>
                                <td th:text="${std.studentName}"></td>
                                <td><input type="input" name="markObtain" id="i" /></td>
                                <td><input type="checkbox" name="isPresent" id="p" th:checked="${true}" /></td>
                                <td><input type="hidden" name="studentId" th:value="*{studentList[__${stat.index}__].studentId}"/> </td>
                            </tr>
                        </div>
                    </table>
                    <input type="submit" class="btn btn-primary pull-right" id="submit_btn" value="Save"/>
                </form>
        </div>
    </div>

</div>



</body>
</html>

<script type="application/javascript">
    var getCsrf = function () {
        return $('[name=_csrf]').val();
    };
    $( "form" ).submit(function( event ) {
        var rows = [];
        $('.student-list tr').each(function(i, n){
            if (i != 0) {
                var $row = $(n);
                console.log(i);
                rows.push({
                    mark:       $row.find('td:eq(2)').find('input').val(),
                    isPresent:  $row.find('td:eq(3)').find('input').is(':checked'),
                    studentId:  $row.find('td:eq(4)').find('input').val()
                });
            }
        });
        console.log(JSON.stringify(rows));
        var data = "{" +
            "\"examJson\":"+ JSON.stringify(rows) + ","
            + "\"classId\":" + $('#clsId').val() + ","
            + "\"totalMark\":" + $('#totalMark').val() + ","
            + "\"percentile\":" + $('#percentile').val() + ","
            + "\"date\":" + "\"" + $('#date').val() + "\","
            + "\"year\":" + $('#year').val() + ","
            + "\"examType\":" + "\"" + $( "#examType option:selected" ).text() + "\"" + ","
            + "\"subjectId\":" + "\"" + $( "#subject option:selected" ).val() + "\"" +
            "}" ;
        console.log(data);
        $.ajax({
            url: "/exams",
            type: "POST",
            contentType: "application/json",
            dataType: "json",
            data: data,
            beforeSend: function (request) {
                request.setRequestHeader("Accept", "application/json");
                request.setRequestHeader("X-CSRF-TOKEN", getCsrf());
            },
            success: function () {
                console.log("Ajax call success");
                location.reload();
            },
            error: function (xhr) {
                alert(xhr.status + " Problem with ajax call");
            }
        });

        return false;
    });




</script>
